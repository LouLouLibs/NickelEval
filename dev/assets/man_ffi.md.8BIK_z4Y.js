import{_ as a,o as s,c as t,aA as e}from"./chunks/framework.DjrO43NO.js";const c=JSON.parse('{"title":"FFI Mode (High Performance)","description":"","frontmatter":{},"headers":[],"relativePath":"man/ffi.md","filePath":"man/ffi.md","lastUpdated":null}'),l={name:"man/ffi.md"};function n(h,i,r,p,o,d){return s(),t("div",null,[...i[0]||(i[0]=[e(`<h1 id="FFI-Mode-High-Performance" tabindex="-1">FFI Mode (High Performance) <a class="header-anchor" href="#FFI-Mode-High-Performance" aria-label="Permalink to &quot;FFI Mode (High Performance) {#FFI-Mode-High-Performance}&quot;">​</a></h1><p>For repeated evaluations, NickelEval provides native FFI bindings to a Rust library that wraps <code>nickel-lang-core</code>. This eliminates subprocess overhead.</p><h2 id="Checking-FFI-Availability" tabindex="-1">Checking FFI Availability <a class="header-anchor" href="#Checking-FFI-Availability" aria-label="Permalink to &quot;Checking FFI Availability {#Checking-FFI-Availability}&quot;">​</a></h2><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NickelEval</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">check_ffi_available</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># =&gt; true or false</span></span></code></pre></div><p>FFI is available when the compiled Rust library exists in the <code>deps/</code> folder.</p><h2 id="Using-FFI-Evaluation" tabindex="-1">Using FFI Evaluation <a class="header-anchor" href="#Using-FFI-Evaluation" aria-label="Permalink to &quot;Using FFI Evaluation {#Using-FFI-Evaluation}&quot;">​</a></h2><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Basic evaluation</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nickel_eval_ffi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1 + 2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># =&gt; 3</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># With dot-access</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">config </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nickel_eval_ffi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;{ host = </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">localhost</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, port = 8080 }&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">config</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">host  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># =&gt; &quot;localhost&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Typed evaluation</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nickel_eval_ffi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;{ a = 1, b = 2 }&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Dict{String, Int})</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># =&gt; Dict{String, Int64}(&quot;a&quot; =&gt; 1, &quot;b&quot; =&gt; 2)</span></span></code></pre></div><h2 id="Building-the-FFI-Library" tabindex="-1">Building the FFI Library <a class="header-anchor" href="#Building-the-FFI-Library" aria-label="Permalink to &quot;Building the FFI Library {#Building-the-FFI-Library}&quot;">​</a></h2><h3 id="Requirements" tabindex="-1">Requirements <a class="header-anchor" href="#Requirements" aria-label="Permalink to &quot;Requirements {#Requirements}&quot;">​</a></h3><ul><li><p>Rust toolchain (install from <a href="https://rustup.rs" target="_blank" rel="noreferrer">rustup.rs</a>)</p></li><li><p>Cargo</p></li></ul><h3 id="Build-Steps" tabindex="-1">Build Steps <a class="header-anchor" href="#Build-Steps" aria-label="Permalink to &quot;Build Steps {#Build-Steps}&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rust/nickel-jl</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cargo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --release</span></span></code></pre></div><p>Then copy the library to <code>deps/</code>:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># macOS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> target/release/libnickel_jl.dylib</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ../../deps/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Linux</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> target/release/libnickel_jl.so</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ../../deps/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Windows</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> target/release/nickel_jl.dll</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ../../deps/</span></span></code></pre></div><h2 id="Performance-Comparison" tabindex="-1">Performance Comparison <a class="header-anchor" href="#Performance-Comparison" aria-label="Permalink to &quot;Performance Comparison {#Performance-Comparison}&quot;">​</a></h2><p>FFI mode is faster for repeated evaluations because it:</p><ol><li><p><strong>No process spawn</strong>: Direct library calls instead of subprocess</p></li><li><p><strong>Shared memory</strong>: Values transfer directly without serialization</p></li><li><p><strong>Persistent state</strong>: Library remains loaded</p></li></ol><p>For single evaluations, the difference is minimal. For batch processing or interactive use, FFI mode is significantly faster.</p><h2 id="Binary-Protocol" tabindex="-1">Binary Protocol <a class="header-anchor" href="#Binary-Protocol" aria-label="Permalink to &quot;Binary Protocol {#Binary-Protocol}&quot;">​</a></h2><p>The FFI uses a binary protocol that preserves type information:</p><table tabindex="0"><thead><tr><th style="text-align:right;">Type Tag</th><th style="text-align:right;">Nickel Type</th></tr></thead><tbody><tr><td style="text-align:right;">0</td><td style="text-align:right;">Null</td></tr><tr><td style="text-align:right;">1</td><td style="text-align:right;">Bool</td></tr><tr><td style="text-align:right;">2</td><td style="text-align:right;">Int64</td></tr><tr><td style="text-align:right;">3</td><td style="text-align:right;">Float64</td></tr><tr><td style="text-align:right;">4</td><td style="text-align:right;">String</td></tr><tr><td style="text-align:right;">5</td><td style="text-align:right;">Array</td></tr><tr><td style="text-align:right;">6</td><td style="text-align:right;">Record</td></tr></tbody></table><p>This allows direct conversion to Julia types without JSON parsing overhead.</p><h2 id="Fallback-Behavior" tabindex="-1">Fallback Behavior <a class="header-anchor" href="#Fallback-Behavior" aria-label="Permalink to &quot;Fallback Behavior {#Fallback-Behavior}&quot;">​</a></h2><p>If FFI is not available, you can still use the subprocess-based functions:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Always works (uses CLI)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nickel_eval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1 + 2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Requires FFI library</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nickel_eval_ffi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1 + 2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Error if not built</span></span></code></pre></div><h2 id="Troubleshooting" tabindex="-1">Troubleshooting <a class="header-anchor" href="#Troubleshooting" aria-label="Permalink to &quot;Troubleshooting {#Troubleshooting}&quot;">​</a></h2><h3 id="FFI-not-available-Error" tabindex="-1">&quot;FFI not available&quot; Error <a class="header-anchor" href="#FFI-not-available-Error" aria-label="Permalink to &quot;&amp;quot;FFI not available&amp;quot; Error {#&quot;FFI-not-available&quot;-Error}&quot;">​</a></h3><p>Build the Rust library:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rust/nickel-jl</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cargo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --release</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> target/release/libnickel_jl.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ../../deps/</span></span></code></pre></div><h3 id="Library-Not-Found" tabindex="-1">Library Not Found <a class="header-anchor" href="#Library-Not-Found" aria-label="Permalink to &quot;Library Not Found {#Library-Not-Found}&quot;">​</a></h3><p>Ensure the library has the correct name for your platform:</p><ul><li><p>macOS: <code>libnickel_jl.dylib</code></p></li><li><p>Linux: <code>libnickel_jl.so</code></p></li><li><p>Windows: <code>nickel_jl.dll</code></p></li></ul>`,32)])])}const g=a(l,[["render",n]]);export{c as __pageData,g as default};
